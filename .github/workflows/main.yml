name: Sleep Bot CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: sleepbot_test
          POSTGRES_USER: sleepbot_test
          POSTGRES_PASSWORD: sleepbot_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          python -c "import tomllib; f = open('pyproject.toml', 'rb'); data = tomllib.load(f); deps = data['project']['dependencies']; print(' '.join(deps))" | xargs pip install
          python -c "import tomllib; f = open('pyproject.toml', 'rb'); data = tomllib.load(f); deps = data['project']['optional-dependencies']['dev']; print(' '.join(deps))" | xargs pip install

      - name: Run linters
        run: |
          black --check .
          flake8 . --exclude=venv,alembic --max-line-length=100
        continue-on-error: true

      - name: Run mock tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: sleepbot_test
          DB_USER: test_user
          DB_PASSWORD: test_password
          BOT_TOKEN: test_token
        run: |
          pytest tests/mock/ -v --cov=services --cov=repositories --cov=models --cov-report=term-missing --cov-fail-under=0

      - name: Run unit tests
        env:
          DB_HOST: localhost
          DB_PORT: 5432
          DB_NAME: sleepbot_test
          DB_USER: test_user
          DB_PASSWORD: test_password
          BOT_TOKEN: test_token
        run: |
          pytest tests/unit/ -v --cov-append --cov=. --cov-report=xml --cov-report=term-missing --cov-fail-under=0

      - name: Check coverage threshold
        run: |
          coverage report --fail-under=30

      # - name: Run integration tests
      #   env:
      #     BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      #     DB_HOST: localhost
      #     DB_PORT: 5432
      #     DB_NAME: sleepbot_test
      #     DB_USER: test_user
      #     DB_PASSWORD: test_password
      #     ENVIRONMENT: development
      #   run: |
      #     pytest tests/integration/ -v

      # - name: Run smoke tests
      #   env:
      #     BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      #     DB_HOST: localhost
      #     DB_PORT: 5432
      #     DB_NAME: sleepbot_db
      #     DB_USER: sleepbot_user
      #     DB_PASSWORD: sleepbot_password
      #     ENVIRONMENT: development
      #     LOG_LEVEL: INFO
      #   run: |
      #     pytest tests/smoke/ -v

      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          fail_ci_if_error: false

  deploy:
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to server via Docker
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            cd /opt/sleepbot
            git pull origin main
            docker compose --env-file .env.production -f docker-compose.production.yml down
            docker compose --env-file .env.production -f docker-compose.production.yml build --no-cache
            docker compose --env-file .env.production -f docker-compose.production.yml up -d
            docker compose --env-file .env.production -f docker-compose.production.yml logs --tail=50
